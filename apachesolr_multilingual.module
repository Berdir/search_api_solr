<?php

/**
 * @file
 * Multilingual search using Apache Solr.
 *
 * @see apachesolr.module
 *
 * @author Markus Kalkbrenner (mkalkbrenner) | bio.logis GmbH
 *   @see http://drupal.org/user/124705
 */

/**
 * Implements hook_node_insert().
 *
 * @return void
 */
function apachesolr_multilingual_node_insert($node) {
  apachesolr_multilingual_node_update($node);
}

/**
 * Implements hook_node_delete().
 *
 * @return void
 */
function apachesolr_multilingual_node_delete($node) {
  apachesolr_multilingual_node_update($node);
}

/**
 * Implements hook_node_update().
 *
 * @return void
 */
function apachesolr_multilingual_node_update($node) {
  if (variable_get('apachesolr_multilingual_index_translations', 0) && !empty($node->tnid)) {
    $translations = translation_node_get_translations($node->tnid);
    foreach ($translations as $node_stub) {
      if ($node_stub->nid != $node->nid) {
        apachesolr_mark_entity('node', $node_stub->nid);
      }
    }
  }
}


/**
 * Implements hook_apachesolr_index_documents_alter().
 */
function apachesolr_multilingual_apachesolr_index_documents_alter(&$documents, $entity, $entity_type, $env_id) {
  foreach ($documents as $document) {
    if ('node' == $document->entity_type) {

      if (LANGUAGE_NONE == $document->ss_language) {
        // Language neutral
        $document->ss_language = variable_get('apachesolr_multilingual_map_language_neutral', LANGUAGE_NONE);
      }

      $fields = $document->getFieldNames();
//       if (in_array('vid', $fields) && is_array($document->vid)) { // vid is vocabulary id in this case
//         $term_languages = array($language);
//         if (module_exists('i18ntaxonomy') && variable_get('apachesolr_multilingual_index_term_translations', 0)) {
//           $term_languages = variable_get('apachesolr_multilingual_languages', array());
//         }
//         foreach ($term_languages as $term_language) {
//           if ($term_language) {
//             $vids = array_unique($document->vid);
//             $terms = array();
//             foreach ($vids as $vid) {
//               if (module_exists('i18ntaxonomy')) {
//                 $tmp = '';
//                 if (in_array('im_vid_' . $vid, $fields)) {
//                   foreach ($document->{'im_vid_' . $vid} as $tid) {
//                     $term = i18nstrings("taxonomy:term:$tid:name", '', $term_language);
//                     if (!empty($term)) {
//                       $tmp .= $term . ' ';
//                     }
//                   }
//                 }
//                 if (!empty($tmp)) {
//                   $terms[] = $tmp;
//                 }
//               }
//               else {
//                 // module i18ntaxonomy isn't installed
//                 // in this case we simply copy the terms
//                 if (in_array('ts_vid_' . $vid . '_names', $fields)) {
//                   $terms[] = $document->{'ts_vid_' . $vid . '_names'};
//                 }
//                 // REVIEW see http://drupal.org/node/783924
//               }
//             }

//             if ($terms) {
//               $document->{'taxonomy_names_' . $term_language} = $terms;
//             }
//           }
//         }
//       }

      // use language specific stemming and so on
      // by copying all fields of type text to
      // a language specific text field
      if (in_array('label', $fields)) {
        $document->{'label_' . $document->ss_language} = $document->label;
      }
      if (in_array('teaser', $fields)) {
        $document->{'teaser_' . $document->ss_language} = $document->teaser;
      }
      if (in_array('content', $fields)) {
        $document->{'content_' . $document->ss_language} = $document->content;
      }
      if (in_array('path_alias', $fields)) {
        $document->{'path_alias_' . $document->ss_language} = $document->path_alias;
      }
      foreach ($fields as $field_name) {
        foreach (array('ts_', 'tm_', 'tos_', 'tom_', 'tags_') as $prefix) {
          if (strpos($field_name, $prefix) === 0 && !empty($document->{$field_name})) {
            // search for existing language identifier at second position
            $tmp = explode('_', $field_name);
            if ($document->ss_language != $tmp[1]) {
              $document->{$tmp[0] . '_' . $document->ss_language . drupal_substr($field_name, strlen($tmp[0]))} = $document->{$field_name};
            }
          }
        }
      }

      if (variable_get('apachesolr_multilingual_index_translations', 0) && in_array('is_tnid', $fields) && !empty($document->is_tnid)) {
        $translations = translation_node_get_translations($document->is_tnid);
        foreach ($translations as $node_stub) {
          if ($node_stub->nid != $document->entity_id) {
            if ($translation_node = node_load($node_stub->nid)) {
              $translation_document = new ApacheSolrDocument();
              apachesolr_index_node_solr_document($translation_document, $translation_node, 'node', $env_id);
              $translation_fields = $translation_document->getFieldNames();
              // use language specific stemming and so on
              // by copying all fields of type text to
              // a language specific text field
              if (in_array('label', $translation_fields)) {
                $document->{'label_' . $translation_document->ss_language} = $translation_document->label;
              }
              if (in_array('teaser', $translation_fields)) {
                $document->{'teaser_' . $translation_document->ss_language} = $translation_document->teaser;
              }
              if (in_array('content', $translation_fields)) {
                $document->{'content_' . $translation_document->ss_language} = $translation_document->content;
              }
              if (in_array('path_alias', $translation_fields)) {
                $document->{'path_alias_' . $translation_document->ss_language} = $translation_document->path_alias;
              }
              foreach ($translation_fields as $field_name) {
                foreach (array('ts_', 'tm_', 'tos_', 'tom_', 'tags_') as $prefix) {
                  if (strpos($field_name, $prefix) === 0 && !empty($translation_document->{$field_name})) {
                    // search for existing language identifier at second position
                    $tmp = explode('_', $field_name);
                    if ($translation_document->ss_language != $tmp[1]) {
                      $document->{$tmp[0] . '_' . $translation_document->ss_language . drupal_substr($field_name, strlen($tmp[0]))} = $translation_document->{$field_name};
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}


/**
 * Implements hook_form_apachesolr_search_bias_form_alter().
 *
 * @param $form
 * @param $state
 * @param $form_id
 * @return mixed
 */
function apachesolr_multilingual_form_apachesolr_search_bias_form_alter(&$form, &$form_state, $form_id) {
  $environment = apachesolr_environment_load($form['#env_id']);
  $fields = apachesolr_search_get_fields($environment);
  $selected_languages = variable_get('apachesolr_multilingual_languages', array());
  $types = array('text');
  $defaults = array();
  foreach ($selected_languages as $langauge) {
    $types[] = 'text_' . $langauge;
    // get the current weights
    $defaults['content_' . $langauge] = '1.0';
    $defaults['ts_' . $langauge .'_comments'] = '0.5';
    $defaults['tos_' . $langauge .'_content_extra'] = '0.1';
    $defaults['label_' . $langauge] = '5.0';
    $defaults['tos_' . $langauge .'_name'] = '3.0';
    $defaults['taxonomy_names_' . $langauge] = '2.0';
    $defaults['tags_' . $langauge .'_h1'] = '5.0';
    $defaults['tags_' . $langauge .'_h2_h3'] = '3.0';
    $defaults['tags_' . $langauge .'_h4_h5_h6'] = '2.0';
    $defaults['tags_' . $langauge .'_inline'] = '1.0';
    $defaults['tags_' . $langauge .'_a'] = '0';
  }

  $qf = apachesolr_environment_variable_get($environment['env_id'], 'field_bias', $defaults);
  $weights = drupal_map_assoc(array('21.0', '13.0', '8.0', '5.0', '3.0', '2.0', '1.0', '0.8', '0.5', '0.3', '0.2', '0.1'));
  $weights['0'] = t('Omit');
  if (!$qf) {
    $qf = $defaults;
  }
  if ($fields) {
    foreach ($fields as $field_name => $field) {
      // Only indexed feids are searchable.
      if ($field->schema{0} == 'I') {
        // We use filter_xss to make sure links are allowed
        $form['field_bias'][$field_name] = array(
          '#access' => in_array($field->type, $types),
          '#type' => 'select',
          '#options' => $weights,
          '#title' => filter_xss(apachesolr_field_name_map($field_name)),
          '#default_value' => isset($qf[$field_name]) ? $qf[$field_name] : '0',
          '#description' => 'text' == $field->type ? t('Unspecified language: recomandation is set this bias to "Omit"') : '',
        );
      }
    }

    // Make sure all the default fields are included, even if they have
    // no indexed content.
    foreach ($defaults as $field_name => $weight) {
      $form['field_bias'][$field_name] = array(
        '#type' => 'select',
        '#options' => $weights,
        '#title' => check_plain(apachesolr_field_name_map($field_name)),
        '#default_value' => isset($qf[$field_name]) ? $qf[$field_name] : $defaults[$field_name],
      );
    }

    ksort($form['field_bias']);
  }
}

/**
 * Implements hook_apachesolr_field_name_map_alter().
 */
function apachesolr_multilingual_apachesolr_field_name_map_alter(&$map) {
  $active_languages = locale_language_list();
  foreach ($active_languages as $language => $language_name) {
    $map['content_' . $language] = $language_name .': ' . t('The full, rendered content (e.g. the rendered node body)');
    $map['ts_' . $language . '_comments'] = $language_name .': ' . t('The rendered comments associated with a node');
    $map['tos_' . $language . '_content_extra'] = $language_name .': ' . t('Extra rendered content or keywords');
    $map['tos_' . $language . '_name_formatted'] = $language_name .': ' . t('Author name (Formatted)');
    $map['label_' . $language] = $language_name .': ' . t('Title or label');
    $map['teaser_' . $language] = $language_name .': ' . t('Teaser or preview');
    $map['tos_' . $language . '_name'] = $language_name .': ' . t('Author name');
    $map['path_alias_' . $language] = $language_name .': ' . t('Path alias');
    $map['tags_h1_' . $language] = $language_name .': ' . t('Body text inside H1 tags');
    $map['tags_h2_h3_' . $language] = $language_name .': ' . t('Body text inside H2 or H3 tags');
    $map['tags_h4_h5_h6_' . $language] = $language_name .': ' . t('Body text inside H4, H5, or H6 tags');
    $map['tags_inline_' . $language] = $language_name .': ' . t('Body text in inline tags like EM or STRONG');
    $map['tags_a_' . $language] = $language_name .': ' . t('Body text inside links (A tags)');
//     if (module_exists('taxonomy')) {
//      $map['taxonomy_names' => t('All taxonomy term names'),
//       foreach (taxonomy_get_vocabularies() as $vocab) {
//         $map['tm_vid_' . $vocab->vid . '_names'] = t('Taxonomy term names only from the %name vocabulary', array('%name' => $vocab->name));
//         $map['im_vid_' . $vocab->vid] = t('Taxonomy term IDs from the %name vocabulary', array('%name' => $vocab->name));
//       }
//     }
//   }
  }
}


/**
 * Implements hook_menu().
 */
function apachesolr_multilingual_menu() {

  $items['admin/config/search/apachesolr/multilingual'] = array(
    'title' => 'Multilingual',
    'weight' => 0,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('apachesolr_multilingual_admin_form'),
    'file' => 'apachesolr_multilingual.admin.inc',
    'access arguments'   => array('administer search'),
    'type' => MENU_LOCAL_TASK,
  );

  return $items;
}


/**
 * Implements hook_apachesolr_confgen_schema_alter().
 */
function apachesolr_multilingual_apachesolr_confgen_schema_alter($qp, $solr_version) {
  module_load_include('inc', 'apachesolr_multilingual', 'apachesolr_multilingual.schema_generator');
  apachesolr_multilingual_modify_schema($qp, $solr_version);
}


/**
 * Implements hook_apachesolr_confgen_solrconfig_alter().
 */
function apachesolr_multilingual_apachesolr_confgen_solrconfig_alter($qp, $solr_version) {
  module_load_include('inc', 'apachesolr_multilingual', 'apachesolr_multilingual.schema_generator');
  apachesolr_multilingual_modify_solrconfig($qp, $solr_version);
}

/**
 * Helper function that returns the name of a stemmer
 * if available
 *
 * @param string
 *   the language id
 *
 * @return string
 *   the name of the stemmer
 */
function apachesolr_multilingual_get_stemmer($language_id = NULL) {
  static $available_stemmers = array(
    'da' => 'Danish',
    'nl' => 'Dutch',
    'en' => 'English',
    'fi' => 'Finnish',
    'fr' => 'French',
    'de' => 'German',
    'it' => 'Italian',
    'nn' => 'Norwegian',
    'nb' => 'Norwegian',
    'pt-br' => 'Portuguese',
    'pt-pt' => 'Portuguese',
    'ro' => 'Romanian',
    'ru' => 'Russian',
    'es' => 'Spanish',
    'sv' => 'Swedish',
    'tr' => 'Turkish',
  );

  if (is_null($language_id)) {
    return $available_stemmers;
  }

  if (array_key_exists($language_id, $available_stemmers)) {
    return $available_stemmers[$language_id];
  }

  return variable_get('apachesolr_multilingual_stemmer_' .  $language_id, '');
}

/**
 * Implements hook_apachesolr_modify_query().
 */
function apachesolr_multilingual_apachesolr_query_alter($query) {
  global $language;

  $languages = variable_get('apachesolr_multilingual_languages', array());

  $qf = $query->getParam('qf');
  foreach ($qf as $index => $field) {
    if (strpos($field, 'content') === 0) {
      list($field_name, $boost) = explode('^', $field);
      // Normed fields tend to have a lower score. Multiplying by 40 is
      // a rough attempt to bring the score in line with fields that are
      // not normed.
      $qf[$index] = $field_name . '^' . (40.0 * $boost);
    }
  }

  $filter_language = '';

  // We assume that a user is not able to select two different languages as filter
  $language_filters = $query->getFilters('ss_language');
  if (!empty($language_filters)) {
    //FIXME
    var_dump($language_filters);
    exit();
    $filter_language = $language_filters[0]['#value'];
  }


  if (!$filter_language && variable_get('apachesolr_multilingual_auto_language_filter', 0) &&
    (!variable_get('apachesolr_multilingual_auto_language_filter_detachable', 0) ||
    (variable_get('apachesolr_multilingual_auto_language_filter_detachable', 0) && empty($_GET['detach-auto-language-filter'])))) {

    if (!empty($language->language)) {
      if (in_array($language->language, $languages)) {
        $filter_language = $language->language;
        $query->addFilter('ss_language', $filter_language);
      }
    }
    elseif (variable_get('apachesolr_multilingual_map_language_neutral', '')) {
      $filter_language = variable_get('apachesolr_multilingual_map_language_neutral', '');
      if ($filter_language) {
        $query->addFilter('ss_language', $filter_language);
      }
    }
  }

  if ($filter_language && in_array($filter_language, $languages)) {
    foreach ($qf as $index => $field) {
      foreach (array('label_', 'teaser_', 'content_', 'path_alias_', 'ts_', 'tm_', 'tos_', 'tom_', 'tags_') as $prefix) {
        if (strpos($field, $prefix) === 0 && strpos($field, $prefix . $filter_language) !== 0) {
          // don't search fields defined for different languages
          unset($qf[$index]);
          break;
        }
      }
    }
    $query->replaceParam('qf', $qf);

    // use language specfic fields for keyword highlighting in search result snippets
    $query->replaceParam('hl.fl', 'content_' . $filter_language);
    $query->addParam('f.content_' . $filter_language .'.hl.alternateField', 'teaser_' . $filter_language);

//     if (variable_get('apachesolr_search_spellcheck', FALSE) && array_key_exists('spell_' . $filter_language, $fields)) {
//       $params['spellcheck.dictionary'] = 'spellchecker_' . $filter_language;
//     }
  }
}


/**
 * Implements hook_form_search_form_alter().
 *
 * @param $form
 * @param $form_state
 */
function apachesolr_multilingual_form_search_form_alter(&$form, $form_state) {
  if ($form['module']['#value'] == 'apachesolr_search') {
    if (variable_get('apachesolr_multilingual_auto_language_filter', 0) && variable_get('apachesolr_multilingual_auto_language_filter_detachable', 0)) {
      $lang_filter = (!empty($_GET['filters']) && strpos($_GET['filters'], 'language:') !== FALSE);

      $form['basic']['apachesolr_search']['detach_auto_language_filter'] = array(
        '#type' => $lang_filter ? 'hidden' : 'checkbox',
        '#title' => t('Search all languages'),
        '#default_value' => isset($_GET['detach-auto-language-filter']),
      );

      $form['#submit'] = array_merge(array('apachesolr_multilingual_form_search_submit'), $form['#submit']);
    }
  }
}


/**
 * @see apachesolr_multilingual_form_search_form_alter()
 */
function apachesolr_multilingual_form_search_submit($form, &$form_state) {
  $fv = $form_state['values'];
  if (!empty($fv['apachesolr_search']['get'])) {
    $get = json_decode($fv['apachesolr_search']['get'], TRUE);

    if (!empty($fv['apachesolr_search']['detach_auto_language_filter'])) {
      $get['detach-auto-language-filter'] = '1';
    }
    elseif (isset($get['detach-auto-language-filter'])) {
      unset($get['detach-auto-language-filter']);
    }

    $form_state['values']['apachesolr_search']['get'] = json_encode($get);
  }
}


/**
 * Implements hook_apachesolr_facets().
 */
function apachesolr_multilingual_apachesolr_facets() {
  $facets['apachesolr_multilingual_language'] = array(
    'info' => t('Apache Solr Multilingual: Filter by Language'),
    'facet_field' => 'language',
  );

  return $facets;
}


/**
 * Implements hook_block_info().
 */
function apachesolr_multilingual_block_info() {
  $module = 'apachesolr_multilingual';
  $env_id = apachesolr_default_environment();
  $enabled_facets = facetapi_get_enabled_facets('apachesolr@' . $env_id, $module);
  $facets = apachesolr_multilingual_apachesolr_facets();

  // Add the blocks
  $blocks = array();
  foreach ($enabled_facets as $delta => $facet_info) {
    if (isset($facets[$delta])) {
      $blocks[$delta] = $facets[$delta] + array('cache' => DRUPAL_NO_CACHE);
    }
  }
  return $blocks;
}

/**
 * Implements hook_block_configure().
 */
function apachesolr_multilingual_block_configure($delta = '') {
  return apachesolr_facetcount_form('apachesolr_multilingual', $delta);
}

/**
 * Implements hook_block_save().
 */
function apachesolr_multilingual_block_save($delta, $edit) {
  apachesolr_facetcount_save($edit);
}


/**
 * Implements hook_block_view().
 */
function apachesolr_multilingual_block_view($delta = '') {
  if (apachesolr_has_searched()) {
    $response = apachesolr_static_response_cache();
    if (empty($response)) {
      return;
    }
    $query = apachesolr_current_query();
    $facets = apachesolr_multilingual_apachesolr_facets();

    if (isset($facets[$delta]) && (!variable_get('apachesolr_multilingual_auto_language_filter', 0)
      || (variable_get('apachesolr_multilingual_auto_language_filter', 0)
      && variable_get('apachesolr_multilingual_auto_language_filter_detachable', 0))
      && (count((array) $response->facet_counts->facet_fields->$facets[$delta]['facet_field']) > 1
      || strpos($_GET['filters'], 'language:') !== FALSE))) {
        return apachesolr_facet_block($response, $query, 'apachesolr_multilingual', $delta, t('Filter by language'), 'apachesolr_search_language_name');
    }
  }
}

function apachesolr_multilingual_get_i18n_variables() {
  module_load_include('inc', 'variable');
  $list = variable_list_group('apachesolr_multilingual');
  return array_keys($list);
}

function apachesolr_multilingual_get_apachesolr_confgen_textfiles_i18n_variables() {
  if (!module_exists('apachesolr_confgen_textfiles')) {
    return array();
  }
  module_load_include('inc', 'variable');
  $list = variable_list_group('apachesolr_confgen_textfiles');
  return array_keys($list);
}

/**
 * Implements hook_modules_enabled().
 */
function apachesolr_multilingual_modules_enabled($modules) {
  if (in_array('apachesolr_confgen_textfiles', $modules)) {
    module_load_include('install', 'apachesolr_multilingual');
    apachesolr_multilingual_enable();
  }
}

/**
 * Implements hook_modules_disabled().
 */
function apachesolr_multilingual_modules_disabled($modules) {
  if (in_array('apachesolr_confgen_textfiles', $modules)) {
    variable_cache_clear();
    $old_variables = apachesolr_multilingual_get_apachesolr_confgen_textfiles_i18n_variables();
    $controller = variable_realm_controller('language');
    $new_variables = $controller->getEnabledVariables();
    $variables = array_diff($new_variables, $old_variables);
    $controller->setRealmVariable('list', $variables);
  }
}

/**
 * Implements hook_variable_realm_variable_list_alter.
 *
 * Prevents removal of apachesolr_multilingual variables
 * from the list of multilingual variables.
 */
function apachesolr_multilingual_variable_realm_variable_list_alter(&$variables, $realm_name) {
  if ('language' == $realm_name) {
    $new_variables = array_merge($variables, apachesolr_multilingual_get_i18n_variables());
    $diff = array_diff($new_variables, $variables);
    if (!empty($diff)) {
      foreach ($diff as $name) {
        $info = variable_get_info($name);
        drupal_set_message(t('Variable %title has been declared as multilingual by Apache Solr Multilingual and cannot be removed from the list of multilingual variables.', array('%title' => $info['title'])), 'error');
      }

      $variables = $new_variables;
    }
  }
}
